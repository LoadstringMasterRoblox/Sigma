name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install provisioning profile
      env:
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
        P12_CERTIFICATE: ${{ secrets.P12_CERTIFICATE }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      run: |
        # Create temporary keychain
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
        
        # Import certificate if provided
        if [ ! -z "$P12_CERTIFICATE" ]; then
          echo $P12_CERTIFICATE | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          rm certificate.p12
        fi
        
        # Install provisioning profile if provided
        if [ ! -z "$PROVISIONING_PROFILE" ]; then
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo $PROVISIONING_PROFILE | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
        fi
    
    - name: Build app (without code signing for testing)
      run: |
        xcodebuild clean build \
          -project PuzzleGame.xcodeproj \
          -scheme PuzzleGame \
          -configuration Release \
          -sdk iphoneos \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -derivedDataPath build
    
    - name: Create IPA
      run: |
        mkdir -p Payload
        cp -r build/Build/Products/Release-iphoneos/PuzzleGame.app Payload/
        zip -r PuzzleGame.ipa Payload
        rm -rf Payload
    
    - name: Upload IPA
      uses: actions/upload-artifact@v3
      with:
        name: PuzzleGame-IPA
        path: PuzzleGame.ipa
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: PuzzleGame.ipa
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
